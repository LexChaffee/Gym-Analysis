---
title: "Gym Analysis Project"
author: "Lex Chaffee"
date: "2025-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(corrplot)
library(readr)
library(tidyverse)
```
Age: Age of the gym member.
Gender: Gender of the gym member (Male or Female).
Weight (kg): Member’s weight in kilograms.
Height (m): Member’s height in meters.
Max_BPM: Maximum heart rate (beats per minute) during workout sessions.
Avg_BPM: Average heart rate during workout sessions.
Resting_BPM: Heart rate at rest before workout.
Session_Duration (hours): Duration of each workout session in hours.
Calories_Burned: Total calories burned during each session.
Workout_Type: Type of workout performed (e.g., Cardio, Strength, Yoga, HIIT).
Fat_Percentage: Body fat percentage of the member.
Water_Intake (liters): Daily water intake during workouts.
Workout_Frequency (days/week): Number of workout sessions per week.
Experience_Level: Level of experience, from beginner (1) to expert (3).
BMI: Body Mass Index, calculated from height and weight.

# EDA 
```{r Data, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# read in data from csv file
gym_data <- read_csv("gym_members_exercise_tracking.csv")

# Shorten column names
colnames(gym_data) <- c("Age", "Gender", "Weight", "Height", "MaxBPM", "AvgBPM", "RestBPM", 
                  "Duration", "CaloriesBurned", "WorkoutType", "FatPct", "WaterIntake", "Freq", 
                  "ExpLvl", "BMI")

```

## Univariate Analysis

Get Basic Summary Statisics for all of the variables
```{r}
summary(gym_data)
```
Check for missingness in the data
```{r}
# Check missingness
is_na_df <- is.na(gym_data)

# Calculate missing counts and percentages
missing_count <- colSums(is_na_df)
missing_percent <- (missing_count / nrow(gym_data)) * 100

# Create a summary table
missing_table <- data.frame(
  Variable = names(missing_count),
  Missing_Count = missing_count,
  Missing_Percent = round(missing_percent, 2)
)

# Sort by missing percentage (optional)
missing_table <- missing_table[order(-missing_table$Missing_Percent), ]

# Print nicely
print(missing_table, row.names = FALSE)

```
None of the data is missing making analysis of the data easier. 

```{r}
#separate categorical from continuous
gym_data$Freq <- as.factor(gym_data$Freq)
gym_data$ExpLvl <- as.factor(gym_data$ExpLvl)

categorical <- gym_data |> select(c('Gender', 'WorkoutType', 'Freq', 'ExpLvl'))
continuous <- gym_data |> select(-colnames(categorical))
```

## Univariate EDA

```{r}
# Loop through each variable to create a QQ plot
for (variable_name in colnames(continuous)) {
  qqnorm(gym_data[[variable_name]],
         main = paste("Normal Q-Q Plot for", variable_name))
  qqline(gym_data[[variable_name]], col = "red")
}

```
```{r}
# Verify normality using a Shapiro-Wilk's test
shapiro_results <- lapply(continuous, shapiro.test)

print(shapiro_results)
```
After running this test we see that there is no continuous variable that has normality. This means going forward we have to use to a non-parametric test if we perform any testing. 

Now let's examine the categorical variables
```{r}
for (variable_name in colnames(categorical)) {
  p <- ggplot(categorical, aes_string(x = variable_name)) +
    geom_bar(fill = "steelblue", width = 0.8) 
  print(p)
}

```
Nothing too special is seen in the categorical variables but more may be revealed during bivariate analysis

## Bivariate Analysis

Let's make scatterplots to examine the relationship of continous variables with eachother
```{r}
vars <- colnames(continuous)

# Loop through all combinations of two different continuous variables
for (i in 1:(length(vars)-1)) {
  for (j in (i+1):length(vars)) {
    x_var <- vars[i]
    y_var <- vars[j]
    
    p <- ggplot(continuous, aes_string(x = x_var, y = y_var)) +
      geom_point(color = "steelblue", alpha = 0.6) +
      labs(title = paste("Scatterplot of", x_var, "vs", y_var),
           x = x_var,
           y = y_var) +
      theme_minimal()
    
    print(p)
  }
}
```
Linear:
There might be a slight correlation between Age and calories burned
Height vs Water Intake and Height vs BMI seem to be slightly correlated
Weight and BMI are strongly correlated
Duration and calories burned are strongly correlated
Calories Burned vs Fat Pct

Strange Boundaries: 
The relationship between weight and height seems to have strange boundaries (look at data source)
Weight and FatPct also has strange boundaries and an outlier group
Durration vs FatPct
Durrations vs FatPct
Durration vs BMI

Spikes:
Weight and duration has an interesting relationship as there are two spikes in duration for certain weights
Weight and Calories burned also has an similar relation as above 



Now let's make boxplots to compare continuous to categorical variables so the continuous variables are across different levels
```{r}
cat_vars <- colnames(categorical)
cont_vars <- colnames(continuous)

# Loop through all categorical-continuous combinations
for (cat_var in cat_vars) {
  for (cont_var in cont_vars) {
    p <- ggplot(gym_data, aes_string(x = cat_var, y = cont_var)) +
      geom_boxplot(fill = "steelblue", alpha = 0.7) +
      labs(title = paste("Boxplot of", cont_var, "by", cat_var),
           x = cat_var,
           y = cont_var) +
      theme_minimal()
    
    print(p)
  }
}
```
Weight, Height, FatPct, WaterIntake, appears to differ by gender
Perhaps CaloriesBurned, BMI has a difference across gender
We can test this using a Wilcoxon Rank Test
```{r}
#use Wilcoxon rank test to see if there is a statsitical difference because Gender is binary
wilcox.test(Weight ~ Gender, data = gym_data)
wilcox.test(Height ~ Gender, data = gym_data)
wilcox.test(FatPct ~ Gender, data = gym_data)
wilcox.test(WaterIntake ~ Gender, data = gym_data)
wilcox.test(CaloriesBurned ~ Gender, data = gym_data)
wilcox.test(BMI ~ Gender, data = gym_data)

```
All variables  differ by gender



Duration appears to differ across Freq
CaloriesBurned appears to differ across Freq
FatPct appears to differ across Freq 
Water intake might differ across Freq
```{r}
#use kruskal wallis to test difference accorss Freq
kruskal.test(Duration ~ Freq, data = gym_data)
kruskal.test(CaloriesBurned ~ Freq, data = gym_data)
kruskal.test(FatPct ~ Freq, data = gym_data)
kruskal.test(WaterIntake ~ Freq, data = gym_data)
```
All variables  differ by freq


Duration appears to differ across ExpLvL
CaloriesBurned appears to differ across ExpLvL
FatPct appears to differ across ExpLvL
Water intake might differ across ExpLvL
```{r}
#use kruskal wallis to test difference accorss ExpLvl
kruskal.test(Duration ~ ExpLvl, data = gym_data)
kruskal.test(CaloriesBurned ~ ExpLvl, data = gym_data)
kruskal.test(FatPct ~ ExpLvl, data = gym_data)
kruskal.test(WaterIntake ~ ExpLvl, data = gym_data)
```
All variables  differ by ExpLvl

Between workout type there doesn't appear to be any significant differences across levels





Let's create a correlation matrix of the continuous variables
```{r}
mydata.cor = cor(continuous, method = c("spearman"))


corr_mat=cor(continuous,method="s") #create Spearman correlation matrix

library("corrplot")
corrplot(corr_mat, method = "color",
         type = "upper", order = "hclust",
         addCoef.col = "black",
         tl.col = "black",
         number.cex = 0.7, # Adjust this value to make the numbers smaller
         cl.cex = 0.7)    # Adjust this value to make the legend text smaller

```
Nothing seems to be too correlated so we might have to look for an interaction or reconsider if we can predict calories burned.


Our Redefined scope is trying to predict CaloriesBurned per session based of predictor variables:
# Check for Multicollinearity
```{r}
#make categorical variables into factors
gym_data$Gender <- as.factor(gym_data$Gender)
gym_data$WorkoutType <- as.factor(gym_data$WorkoutType)
gym_data$Freq <- as.factor(gym_data$Freq)
gym_data$ExpLvl <- as.factor(gym_data$ExpLvl)


# Build an inclusive model
full.model <- lm(CaloriesBurned ~ . , data = gym_data)

library(car)
# Calculating VIF
vif_values <- vif(full.model)
vif_values
```
Due to a high VIF we will try to remove Weight to see if the VIF decreases
```{r}
# Build an inclusive model
full.model <- lm(CaloriesBurned ~ Age + Gender + Height + MaxBPM + AvgBPM + RestBPM +
                 Duration + WorkoutType + FatPct + WaterIntake + Freq + ExpLvl + BMI,
                 data = gym_data)

# Calculating VIF
vif_values <- vif(full.model)
vif_values
```
That dealt with our multicollinearity issue so let's move forward with our analysis.



# Candidate Model Selection
Split the dataset into a 70/30 train/test datasets
```{r}
#remove weight from our dataset
gym_data_1 <- gym_data %>% select(-Weight)

set.seed(123)
gym_data_1 <- gym_data_1 %>% mutate(id = row_number())

train <- gym_data_1 %>% sample_frac(0.7)

test <- anti_join(gym_data_1, train, by = 'id')
```


# Stepwise Regression
## Explainatory model with no interactions
```{r }
# Create full model with interactions and empty model
full.model <- lm(CaloriesBurned ~ . , data = train)
empty.model <- lm(CaloriesBurned ~ 1, data = train)
# k = 2 for AIC selection
step.model <- step(empty.model,
scope = list(lower = empty.model,
upper = full.model),
direction = "both",  #k = qchisq(.15, 1, lower.tail = FALSE) 
# k = log(nrow(train))
 k = 2
) 

```

AIC Selection Model:
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Height + 
    RestBPM
    
    
BIC Selection Model:
CaloriesBurned ~ Duration + AvgBPM + Gender + Age

P-Value Selection Model .15: - same as AIC
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Height + 
    RestBPM

P-Value Selection Model .005: - same as BIC
CaloriesBurned ~ Duration + AvgBPM + Gender + Age



Let's now compare these models across different metrics

```{r}
#AIC Selection Model:
aic_model <- lm(CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Height + 
    RestBPM, data = gym_data)

bic_model <- lm(CaloriesBurned ~ Duration + AvgBPM + Gender + Age, data = gym_data)


```

```{r}
# Suppose you have a list of models
models <- list(aic_model, bic_model)
model_names <- c("AIC Model", "BIC Model")

# Initialize a data frame to store results
results <- data.frame(
  Model = character(),
  Adj_R2 = numeric(),
  AIC = numeric(),
  BIC = numeric(),
  stringsAsFactors = FALSE
)

# Loop through models
for (i in seq_along(models)) {
  m <- models[[i]]
  
  adj_rsquared <- summary(m)$adj.r.squared
  model_aic <- AIC(m)
  model_bic <- BIC(m)
  
  results <- rbind(results, data.frame(
    Model = model_names[i],
    Adj_R2 = adj_rsquared,
    AIC = model_aic,
    BIC = model_bic
  ))
}

# View results
print(results)

```

## Predictive models with 2 way interactions
Let's now try creating a better model using stepwise regression:

```{r }
# Create full model with interactions and empty model
full.model <- lm(CaloriesBurned ~ (.)^2 , data = train)
empty.model <- lm(CaloriesBurned ~ 1, data = train)
# k = 2 for AIC selection
step.model <- step(empty.model,
scope = list(lower = empty.model,
upper = full.model),
direction = "both",  k = qchisq(.005, 1, lower.tail = FALSE) #, trace = FALSE
) 

```

AIC Selection Model:
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + BMI + WorkoutType + 
    Duration:AvgBPM + Duration:Gender + Duration:Age + AvgBPM:Gender + 
    AvgBPM:Age + Gender:Age + Duration:BMI + BMI:WorkoutType + 
    Age:BMI
    
    
BIC Selection Model:
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Duration:AvgBPM + 
    Duration:Gender + Duration:Age + AvgBPM:Gender + AvgBPM:Age + 
    Gender:Age

P-Value Selection Model .15: - Same as AIC
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + BMI + WorkoutType + 
    Duration:AvgBPM + Duration:Gender + Duration:Age + AvgBPM:Gender + 
    AvgBPM:Age + Gender:Age + Duration:BMI + BMI:WorkoutType + 
    Age:BMI

P-Value Selection Model .005:
CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Duration:AvgBPM + 
    Duration:Gender + Duration:Age + AvgBPM:Gender + AvgBPM:Age + 
    Gender:Age



Let's now compare these models across different metrics

```{r}
#AIC Selection Model:
aic_model <- lm(CaloriesBurned ~ Duration + AvgBPM + Gender + Age + BMI + WorkoutType + 
    Duration:AvgBPM + Duration:Gender + Duration:Age + AvgBPM:Gender + 
    AvgBPM:Age + Gender:Age + Duration:BMI + BMI:WorkoutType + 
    Age:BMI, data = gym_data)


bic_model <- lm(CaloriesBurned ~ Duration + AvgBPM + Gender + Age + BMI + WorkoutType + 
    Duration:AvgBPM + Duration:Gender + Duration:Age + AvgBPM:Gender + 
    AvgBPM:Age + Gender:Age + Duration:BMI + BMI:WorkoutType + 
    Age:BMI, data = gym_data)

pval.005_model <- lm(CaloriesBurned ~ Duration + AvgBPM + Gender + Age + Duration:AvgBPM + 
    Duration:Gender + Duration:Age + AvgBPM:Gender + AvgBPM:Age + 
    Gender:Age, data = gym_data)
```

```{r}
# Suppose you have a list of models
models <- list(aic_model, bic_model, pval.005_model)
model_names <- c("AIC Model", "BIC Model", ".005 P-value Model")

# Initialize a data frame to store results
results <- data.frame(
  Model = character(),
  Adj_R2 = numeric(),
  AIC = numeric(),
  BIC = numeric(),
  stringsAsFactors = FALSE
)

# Loop through models
for (i in seq_along(models)) {
  m <- models[[i]]
  
  adj_rsquared <- summary(m)$adj.r.squared
  model_aic <- AIC(m)
  model_bic <- BIC(m)
  
  results <- rbind(results, data.frame(
    Model = model_names[i],
    Adj_R2 = adj_rsquared,
    AIC = model_aic,
    BIC = model_bic
  ))
}

# View results
print(results)

```


